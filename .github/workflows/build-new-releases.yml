name: Build new Asterisk releases

on:
  workflow_dispatch:

  push:
    paths:
      - .github/workflows/build-new-releases.yml
      - 'asterisk-releases.txt'

jobs:
  new-releases:
    name: Discover new Asterisk releases
    runs-on: ubuntu-20.04
    timeout-minutes: 5
    outputs:
       matrix: ${{ steps.new-releases.outputs.matrix }}

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set dynamic matrix
        id: new-releases
        shell: bash
        run: |
          set -ueo pipefail

          BUILD_RELEASES="$(
            git log -p -1 ./asterisk-releases.txt \
            | grep -P '^\+\d+' \
            | sed -re 's/^\+//g'
          )"

          # JSON_MATRIX="{\"include\":[{\"run\":\"run1\"},{\"run\":\"run2\"}]}"
          # echo "::set-output name=matrix::${JSON_MATRIX}"

          JSON_MATRIX="$(
            echo -n "$BUILD_RELEASES" \
            | tr '\n' ' ' \
            | jq --slurp -c -R 'split(" ") | map({run: .}) | {include: .}'
          )"

          echo "::set-output name=matrix::${JSON_MATRIX}"

          echo "Continue to build following Asterisk PBX releases:"
          echo "=================================================="
          echo -e "$BUILD_RELEASES"
          echo
          echo
          echo "JSON payload:"
          echo "=================================================="
          echo "$JSON_MATRIX" | jq

  # build:
  #   needs: new-releases
  #   uses: ./.github/workflows/build-asterisk.yml
  #   with:
  #     releases: ${{ needs.new-releases.outputs.matrix }}
